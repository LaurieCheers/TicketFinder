<html>
<head>
<script>
let tickets = [{"price":37.5,"name":"Berlin ABC Weekly Ticket","zone":"ABC","durationDays":7,"expiresTime":"00:00","transferable":true,"covers":[{"adults":1,"dayType":"Week"},{"adults":2,"children":3,"dayType":"Week","startTime":"20:00","endTime":"00:00"},{"adults":2,"children":3,"dayType":"Weekend"}]},{"price":30,"name":"Berlin AB Weekly Ticket","zone":"AB","durationDays":7,"expiresTime":"00:00","transferable":true,"covers":[{"adults":1,"dayType":"Week"},{"adults":2,"children":3,"dayType":"Week","startTime":"20:00","endTime":"00:00"},{"adults":2,"children":3,"dayType":"Weekend"}]},{"price":31.4,"name":"Berlin BC Weekly Ticket","zone":"BC","durationDays":7,"expiresTime":"00:00","transferable":true,"covers":[{"adults":1,"dayType":"Week"},{"adults":2,"children":3,"dayType":"Week","startTime":"20:00","endTime":"00:00"},{"adults":2,"children":3,"dayType":"Weekend"}]},{"price":29,"name":"Berlin-Brandenburg-Ticket (Weekend)","zone":"ABC","startTime":"00:00","dayType":"Weekend","durationHours":27,"transferable":false,"covers":[{"adults":5},{"adults":2,"children":100}]},{"price":29,"name":"Berlin-Brandenburg-Ticket (Week)","zone":"ABC","startTime":"09:00","dayType":"Week","durationHours":18,"transferable":false,"covers":[{"adults":5},{"adults":2,"children":100}]},{"price":22,"name":"Berlin-Brandenburg-Ticket (Night)","zone":"ABC","startTime":"18:00","durationHours":13,"transferable":false,"covers":[{"adults":5},{"adults":2,"children":100}]},{"price":1.7,"name":"Short Trip Ticket","zone":"ABC","shortTrip":true,"transferable":true,"durationHours":2,"covers":[{"adults":1}]},{"price":1.3,"name":"Short Trip Ticket Reduced","zone":"ABC","shortTrip":true,"transferable":true,"durationHours":2,"covers":[{"children":1}]},{"price":1.7,"name":"Ticket Berlin AB (Reduced)","zone":"AB","transferable":true,"durationHours":2,"covers":[{"children":1}]},{"price":2.2,"name":"Ticket Berlin BC (Reduced)","zone":"BC","transferable":true,"durationHours":2,"covers":[{"children":1}]},{"price":2.5,"name":"Ticket Berlin ABC (Reduced)","zone":"ABC","transferable":true,"durationHours":2,"covers":[{"children":1}]},{"price":2.8,"name":"Ticket Berlin AB","zone":"AB","transferable":true,"durationHours":2,"covers":[{"adults":1}]},{"price":3.1,"name":"Ticket Berlin BC","zone":"BC","transferable":true,"durationHours":2,"covers":[{"adults":1}]},{"price":3.4,"name":"Ticket Berlin ABC","zone":"ABC","transferable":true,"durationHours":2,"covers":[{"adults":1}]},{"price":1.6,"name":"Extension Ticket Berlin","zone":"ABC","isExtension":true,"transferable":true,"durationHours":2,"covers":[{"adults":1}]},{"price":4.7,"name":"Day Ticket Berlin AB (Reduced)","zone":"AB","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"children":1}]},{"price":5.1,"name":"Day Ticket Berlin BC (Reduced)","zone":"BC","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"children":1}]},{"price":5.3,"name":"Day Ticket Berlin ABC (Reduced)","zone":"ABC","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"children":1}]},{"price":7,"name":"Day Ticket Berlin AB","zone":"AB","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"adults":1,"children":3}]},{"price":7.4,"name":"Day Ticket Berlin BC","zone":"BC","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"adults":1,"children":3}]},{"price":7.7,"name":"Day Ticket Berlin ABC","zone":"ABC","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"adults":1,"children":3}]},{"price":19.9,"name":"Group Day Ticket Berlin AB","zone":"AB","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"adults":5}]},{"price":20.6,"name":"Group Day Ticket Berlin BC","zone":"BC","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"adults":5}]},{"price":20.8,"name":"Group Day Ticket Berlin ABC","zone":"ABC","transferable":true,"durationDays":1,"expiresTime":"03:00","covers":[{"adults":5}]}];
let ticketsAlreadyBought = [];
function newTicketPurchases()
{
  return { "price":0, "purchases":[] };
}

function addPurchases(basePurchases, extraPurchases)
{
  var newPurchases = basePurchases.purchases.slice();
  for(var Idx = 0; Idx < extraPurchases.purchases; ++Idx)
  {
    newPurchases.push(extraPurchases.purchases[Idx]);
  }

  return {
	"price":basePurchases.price+extraPurchases.price,
	"purchases":newPurchases,
  };
}

function makePurchase(ticket, trip)
{
  var ticketPurchase = { "ticket":ticket, "date":new Date(trip.day + " "+trip.start) };
  //TODO: pick the correct start date/time according to the rules for this ticket
  //TODO: return undefined if this ticket cannot cover this trip

  return {
    "price":ticket.price,
	"purchases":[ ticketPurchase ],
  };
}

function getTripRemainder(allPurchases, trip)
{
  // things that might be partially covered: time range, people, zones
  
  for(let purchase of allPurchases.purchases)
  {
    if(purchase.ticket.shortTrip && !trip.shortTrip)
		continue;
	
    var purchaseDates = getPurchaseDateRange(purchase);
	var tripDates = getTripDateRange(trip);
	var excludedTime = subtractDateRange(tripDates, purchaseDates);
	if(excludedTime === undefined)
	{
	  
	}
  }
}

function isCovered(trip)
{
	return trip.people.length === 0;
}

function findPurchaseOptionsForTrip(allTickets, trip)
{
	if(isCovered(trip))
		return [ newTicketPurchases() ];

	var ticketOptions = [];
	
	for(var ticketIdx = 0; ticketIdx < allTickets.length; ++ticketIdx)
	{
		var ticket = allTickets[ticketIdx];
		var purchase = makePurchase(ticket, trip);
		if(purchase === undefined)
			continue;
		var tripRemainder = getTripRemainder(purchase, trip);
		var extraPurchaseOptions = findPurchaseOptionsForTrip(allTickets, tripRemainder);
		for(var optionIdx = 0; optionIdx < extraPurchaseOptions.length; ++optionIdx)
		{
			ticketOptions.push(addPurchases(purchase, extraPurchaseOptions[optionIdx]));
		}
	}
	
	return ticketOptions;
}

function findTicketsForSchedule(allTickets, trips)
{
	var ticketOptions = [newTicketPurchases()];
	for(var tripIdx = 0; tripIdx < trips.length; ++tripIdx)
	{
		var trip = trips[tripIdx];
		for(var optionIdx = 0; optionsIdx < ticketOptions.length; ++optionsIdx)
		{
			var purchasesSoFar = ticketOptions[optionsIdx];
			var tripRemainder = getTripRemainder(purchasesSoFar, trip);
			var extraPurchaseOptions = findTicketOptionsForTrip(allTickets, tripRemainder);
			for(var extraOptionIdx = 0; extraOptionIdx < extraPurchaseOptions.length; ++extraOptionIdx)
			{
				var extraPurchases = extraPurchaseOptions[extraOptionIdx];
				newTicketOptions.push(addPurchases(purchasesSoFar, extraPurchases));
			}
		}
		//TODO: discard options that are strictly worse than others, e.g. if the price is higher for no benefit
		ticketOptions = newTicketOptions;
	}
	
	var cheapestPrice = 1E9;
	var cheapestOption = undefined;
	for(var optionIdx = 0; optionIdx < ticketOptions.length; ++optionIdx)
	{
		var option = ticketOptions[optionIdx];
		if(option.price < cheapestPrice)
		{
			cheapestOption = option;
			cheapestPrice = option.price;
		}
	}
	return cheapestOption;
}
function getEndTime (validationTime, ticket)
{
	let cloned = new Date(validationTime.valueOf());
	if (ticket.durationHours !== undefined)
		cloned.setHours(cloned.getHours() + ticket.durationHours);
	else
	{
		cloned.setDate(cloned.getDate() + ticket.durationDays);
		let split = ticket.expiresTime.split(':');
		cloned.setHours(split[0]);
		cloned.setMinutes(split[1]);
	}
	return cloned;
}

let peopleO = [];
let trips = [];
function addPerson ()
{
	let o = {};
	let tr = document.createElement('tr');
	let name = document.createElement('td');
	name.innerText = o.name = prompt("What is their name?");
	let age = document.createElement('td');
	age.innerText = o.age = +prompt("What is their age?");
	tr.appendChild(name);
	tr.appendChild(age);
	people.appendChild(tr);
	peopleO.push(o);
	let label = document.createElement('label');
	let checkbox = document.createElement('input');
	checkbox.type = 'checkbox';
	label.appendChild(checkbox);
	label.appendChild(new Text(o.name));
	o.checkbox = checkbox;
	pInvolved.appendChild(label);
}
function addTrip (tripType)
{
	let base = 
	{
		type: tripType,
		fromZone: document.querySelector("input[name=\"zone1\"]:checked").value,
		toZone: document.querySelector("input[name=\"zone2\"]:checked").value,
		people: peopleO.filter(v => v.checkbox.checked).reduce((output, value) => (output[value.name] = {age: value.age}, output), {}),
		day: travelDay.value
	};
	switch (tripType)
	{
		case "single":
			trips.push(
				{
					...base,
					shortTrip: singleShortTrip.checked,
					start: singleStartTime.value || undefined,
					end: singleEndTime.value || undefined
				});
			break;
		case "round":
			base.type = 'single';
			trips.push(
				{
					...base,
					shortTrip: roundShortTrip.checked,
					start: roundStartTime1.value || undefined,
					end: roundEndTime1.value || undefined
				});
			let $from = base.fromZone;
			base.fromZone = base.toZone;
			base.toZone = $from;
			trips.push(
				{
					...base,
					shortTrip: roundShortTrip.checked,
					start: roundStartTime2.value || undefined,
					end: roundEndTime2.value || undefined
				});
			break;
		case "day":
			trips.push(
				{
					...base,
					start: dayStartTime.value || undefined,
					end: dayEndTime.value || undefined
				});
			break;
	}
	f.reset();
	resetTripTypes();
}
function resetTripTypes ()
{
	for (let div of ["single", "round", "day"])
		document.getElementById(div).style.display = 'none';
}
function changeTripType (tripType)
{
	resetTripTypes();
	document.getElementById(tripType).style.display = 'block';
}
function addTicket ()
{
	ticketsAlreadyBought.push({ticket: tickets[ticketTypeSelect.value], day: validated.value});
	addTicketForm.reset();
}
function load ()
{
	for (let idx = 0; idx < tickets.length; idx++)
	{
		let option = document.createElement('option');
		option.value = idx;
		option.appendChild(new Text(tickets[idx].name));
		ticketTypeSelect.appendChild(option);
	}
}
</script>
</head>
<body onload="load()">
<table id=people>
<tr><th>Name</th><th>Age</th></tr>
</table>
<button onclick="addPerson()">Add Person</button>
<form id=addTicketForm>
	<fieldset>
		<legend>Add Already Owned Ticket</legend>
		<label><select id=ticketTypeSelect></select> Ticket Type</label><br>
		<label><input type="datetime-local" id=validated /> Validated</label><br>
		<button onclick="addTicket()" type=button>Add Ticket</button>
	</fieldset>
</form> 
<form id=f>
	<fieldset>
		<legend>Add Trip</legend>
		<div>
			<label>
				<input type="date" id=travelDay />
				Date of Travel
			</label>
		</div>
		<div>
			<label>
				<select id=trip onchange="changeTripType(this.value)">
					<option disabled selected>Choose...</option>
					<option value=single>Single Trip</option>
					<option value=round>Round Trip</option>
					<option value=day>Unlimited Travel between 2 times</option>
				</select>
				Trip Type
			</label>
		</div>
		<fieldset id=pInvolved>
			<legend>Add People</legend>
		</fieldset>
		<table id=zone>
			<tr>
				<td>
					<ul>
						<li>
							<label>
								<input type=radio name=zone1 value=A />
								A
							</label>
						</li>
						<li>
							<label>
								<input type=radio name=zone1 value=B />
								B
							</label>
						</li>
						<li>
							<label>
								<input type=radio name=zone1 value=C />
								C
							</label>
						</li>
					</ul>
				</td>
				<td>
					<ul>
						<li>
							<label>
								<input type=radio name=zone2 value=A />
								A
							</label>
						</li>
						<li>
							<label>
								<input type=radio name=zone2 value=B />
								B
							</label>
						</li>
						<li>
							<label>
								<input type=radio name=zone2 value=C />
								C
							</label>
						</li>
					</ul>
				</td>	
			</tr>
		</table>
		<fieldset>
			<legend>Trip Options</legend>
			<div id=single style="display:none">
				<input type="time" id=singleStartTime /> - <input type=time id=singleEndTime /><br>
				<label><input type=checkbox id=singleShortTrip /> Short Trip</label><br>
				<button type=button onclick="addTrip('single')">Add Trip</button>
			</div>
			<div id=round style="display:none">
				<input type="time" id=roundStartTime1 /> - <input type=time id=roundEndTime1 /><br>
				<input type="time" id=roundStartTime2 /> - <input type=time id=roundEndTime2 /><br>
				<label><input type=checkbox id=roundShortTrip /> Short Trip</label><br>
				<button type=button onclick="addTrip('round')">Add Trip</button>
			</div>
			<div id=day style="display:none">
				<input type="time" id=dayStartTime /> - <input type=time id=dayEndTime /><br>
				<button type=button onclick="addTrip('day')">Add Trip</button>
			</div>
		</fieldset>
	</fieldset>
</form>
<button>Calculate Best Deal</button>
</body>
</html>