<html>
<head>
<script>
function newTicketPurchases()
{
  return { "price":0, "purchases":[] };
}

function addPurchases(basePurchases, extraPurchases)
{
  var newPurchases = basePurchases.purchases.slice();
  for(var Idx = 0; Idx < extraPurchases.purchases; ++Idx)
  {
    newPurchases.push(extraPurchases.purchases[Idx]);
  }

  return {
	"price":basePurchases.price+extraPurchases.price,
	"purchases":newPurchases,
  };
}

function makePurchase(ticket, trip)
{
  var ticketPurchase = { "ticket":ticket, "date":trip.date };
  //TODO: handle the exact trip time/date according to the rules for this ticket
  //TODO: return undefined if this ticket cannot cover this trip

  return {
    "price":ticket.price,
	"purchases":[ ticketPurchase ],
  };
}

function getTripRemainder(purchase, trip)
{
  var result = Object.assign({}, trip);
}

function isCovered(trip)
{
	return trip.people.length === 0;
}

function findPurchaseOptionsForTrip(allTickets, trip)
{
	if(isCovered(trip))
		return [ newTicketPurchases() ];

	var ticketOptions = [];
	
	for(var ticketIdx = 0; ticketIdx < allTickets.length; ++ticketIdx)
	{
		var ticket = allTickets[ticketIdx];
		var purchase = makePurchase(ticket, trip);
		if(purchase === undefined)
			continue;
		var tripRemainder = getTripRemainder(purchase, trip);
		var extraPurchaseOptions = findPurchaseOptionsForTrip(allTickets, tripRemainder);
		for(var optionIdx = 0; optionIdx < extraPurchaseOptions.length; ++optionIdx)
		{
			ticketOptions.push(addPurchases(purchase, extraPurchaseOptions[optionIdx]));
		}
	}
	
	return ticketOptions;
}

function findTicketsForSchedule(allTickets, trips)
{
	var ticketOptions = [newTicketPurchases()];
	for(var tripIdx = 0; tripIdx < trips.length; ++tripIdx)
	{
		var trip = trips[tripIdx];
		for(var optionIdx = 0; optionsIdx < ticketOptions.length; ++optionsIdx)
		{
			var purchasesSoFar = ticketOptions[optionsIdx];
			var tripRemainder = getTripRemainder(purchasesSoFar, trip);
			var extraPurchaseOptions = findTicketOptionsForTrip(allTickets, tripRemainder);
			for(var extraOptionIdx = 0; extraOptionIdx < extraPurchaseOptions.length; ++extraOptionIdx)
			{
				var extraPurchases = extraPurchaseOptions[extraOptionIdx];
				newTicketOptions.push(addPurchases(purchasesSoFar, extraPurchases));
			}
		}
		//TODO: discard options that are strictly worse than others, e.g. if the price is higher for no benefit
		ticketOptions = newTicketOptions;
	}
	
	var cheapestPrice = 1E9;
	var cheapestOption = undefined;
	for(var optionIdx = 0; optionIdx < ticketOptions.length; ++optionIdx)
	{
		var option = ticketOptions[optionIdx];
		if(option.price < cheapestPrice)
		{
			cheapestOption = option;
			cheapestPrice = option.price;
		}
	}
	return cheapestOption;
}


let peopleO = [];
let trips = [];
function addPerson ()
{
	let o = {};
	let tr = document.createElement('tr');
	let name = document.createElement('td');
	name.innerText = o.name = prompt("What is their name?");
	let age = document.createElement('td');
	age.innerText = o.age = +prompt("What is their age?");
	tr.appendChild(name);
	tr.appendChild(age);
	people.appendChild(tr);
	peopleO.push(o);
	let label = document.createElement('label');
	let checkbox = document.createElement('input');
	checkbox.type = 'checkbox';
	label.appendChild(checkbox);
	label.appendChild(new Text(o.name));
	o.checkbox = checkbox;
	pInvolved.appendChild(label);
}
function addTrip (tripType)
{
	let base = 
	{
		type: tripType,
		fromZone: document.querySelector("input[name=\"zone1\"]:checked").value,
		toZone: document.querySelector("input[name=\"zone2\"]:checked").value,
		people: peopleO.filter(v => v.checkbox.checked).reduce((output, value) => (output[value.name] = {age: value.age}, output), {})
	};
	switch (tripType)
	{
		case "single":
			trips.push(
				{
					...base,
					shortTrip: singleShortTrip.checked,
					start: singleStartTime.value || undefined,
					end: singleEndTime.value || undefined
				});
			break;
		case "round":
			base.type = 'single';
			trips.push(
				{
					...base,
					shortTrip: roundShortTrip.checked,
					start: roundStartTime1.value || undefined,
					end: roundEndTime1.value || undefined
				});
			let $from = base.fromZone;
			base.fromZone = base.toZone;
			base.toZone = $from;
			trips.push(
				{
					...base,
					shortTrip: roundShortTrip.checked,
					start: roundStartTime2.value || undefined,
					end: roundEndTime2.value || undefined
				});
			break;
		case "day":
			trips.push(
				{
					...base,
					start: dayStartTime.value || undefined,
					end: dayEndTime.value || undefined
				});
			break;
	}
	j.innerText = JSON.stringify(trips);
	f.reset();
	resetTripTypes();
}
function resetTripTypes ()
{
	for (let div of ["single", "round", "day"])
		document.getElementById(div).style.display = 'none';
}
function changeTripType (tripType)
{
	resetTripTypes();
	document.getElementById(tripType).style.display = 'block';
}
</script>
</head>
<body>
<table id=people>
<tr><th>Name</th><th>Age</th></tr>
</table>
<button onclick="addPerson()">Add Person</button>
<form id=f>
	<fieldset>
		<legend>Add Trip</legend>
		<div>
			<label>
				<input type="date" id=travelDay />
				Date of Travel
			</label>
		</div>
		<div>
			<label>
				<select id=trip onchange="changeTripType(this.value)">
					<option disabled selected>Choose...</option>
					<option value=single>Single Trip</option>
					<option value=round>Round Trip</option>
					<option value=day>Unlimited Travel between 2 times</option>
				</select>
				Trip Type
			</label>
		</div>
		<fieldset id=pInvolved>
			<legend>Add People</legend>
		</fieldset>
		<table id=zone>
			<tr>
				<td>
					<ul>
						<li>
							<label>
								<input type=radio name=zone1 value=A />
								A
							</label>
						</li>
						<li>
							<label>
								<input type=radio name=zone1 value=B />
								B
							</label>
						</li>
						<li>
							<label>
								<input type=radio name=zone1 value=C />
								C
							</label>
						</li>
					</ul>
				</td>
				<td>
					<ul>
						<li>
							<label>
								<input type=radio name=zone2 value=A />
								A
							</label>
						</li>
						<li>
							<label>
								<input type=radio name=zone2 value=B />
								B
							</label>
						</li>
						<li>
							<label>
								<input type=radio name=zone2 value=C />
								C
							</label>
						</li>
					</ul>
				</td>	
			</tr>
		</table>
		<fieldset>
			<legend>Trip Options</legend>
			<div id=single style="display:none">
				<input type="time" id=singleStartTime /> - <input type=time id=singleEndTime /><br>
				<label><input type=checkbox id=singleShortTrip /> Short Trip</label><br>
				<button type=button onclick="addTrip('single')">Add Trip</button>
			</div>
			<div id=round style="display:none">
				<input type="time" id=roundStartTime1 /> - <input type=time id=roundEndTime1 /><br>
				<input type="time" id=roundStartTime2 /> - <input type=time id=roundEndTime2 /><br>
				<label><input type=checkbox id=roundShortTrip /> Short Trip</label><br>
				<button type=button onclick="addTrip('round')">Add Trip</button>
			</div>
			<div id=day style="display:none">
				<input type="time" id=dayStartTime /> - <input type=time id=dayEndTime /><br>
				<button type=button onclick="addTrip('day')">Add Trip</button>
			</div>
		</fieldset>
	</fieldset>
</form>
<textarea id=j>
</textarea>
</body>
</html>